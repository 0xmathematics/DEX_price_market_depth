#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Tue Jun 25 11:45:12 2024

@author: Hang Miao
"""

import os
from web3 import Web3
import numpy as np
import pandas as pd
import json
import datetime
import time
import tqdm
from math import sqrt, pi

os.chdir('/Users/hang.miaosmartcontract.com/Documents/GitHub/quantitative_analysis/web3')
infura_url = "https://mainnet.infura.io/v3/52757b6af51f4a50a7645433e21e0d90" # eth
infura_url = "https://arbitrum-mainnet.infura.io/v3/52757b6af51f4a50a7645433e21e0d90"  # arbitrum
web3 = Web3(Web3.HTTPProvider(infura_url))
print( web3.is_connected() )
web3.eth.get_block_number() 
#%%
####################################################
# wstETH/ETH
####################################################

abi = json.loads('[{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"int24","name":"bottomTick","type":"int24"},{"indexed":true,"internalType":"int24","name":"topTick","type":"int24"},{"indexed":false,"internalType":"uint128","name":"liquidityAmount","type":"uint128"},{"indexed":false,"internalType":"uint256","name":"amount0","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount1","type":"uint256"}],"name":"Burn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":false,"internalType":"address","name":"recipient","type":"address"},{"indexed":true,"internalType":"int24","name":"bottomTick","type":"int24"},{"indexed":true,"internalType":"int24","name":"topTick","type":"int24"},{"indexed":false,"internalType":"uint128","name":"amount0","type":"uint128"},{"indexed":false,"internalType":"uint128","name":"amount1","type":"uint128"}],"name":"Collect","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint8","name":"communityFee0New","type":"uint8"},{"indexed":false,"internalType":"uint8","name":"communityFee1New","type":"uint8"}],"name":"CommunityFee","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint16","name":"feeZto","type":"uint16"},{"indexed":false,"internalType":"uint16","name":"feeOtz","type":"uint16"}],"name":"Fee","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"sender","type":"address"},{"indexed":true,"internalType":"address","name":"recipient","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount0","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount1","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"paid0","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"paid1","type":"uint256"}],"name":"Flash","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"virtualPoolAddress","type":"address"}],"name":"Incentive","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint160","name":"price","type":"uint160"},{"indexed":false,"internalType":"int24","name":"tick","type":"int24"}],"name":"Initialize","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint32","name":"liquidityCooldown","type":"uint32"}],"name":"LiquidityCooldown","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"sender","type":"address"},{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"int24","name":"bottomTick","type":"int24"},{"indexed":true,"internalType":"int24","name":"topTick","type":"int24"},{"indexed":false,"internalType":"uint128","name":"liquidityAmount","type":"uint128"},{"indexed":false,"internalType":"uint256","name":"amount0","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount1","type":"uint256"}],"name":"Mint","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"sender","type":"address"},{"indexed":true,"internalType":"address","name":"recipient","type":"address"},{"indexed":false,"internalType":"int256","name":"amount0","type":"int256"},{"indexed":false,"internalType":"int256","name":"amount1","type":"int256"},{"indexed":false,"internalType":"uint160","name":"price","type":"uint160"},{"indexed":false,"internalType":"uint128","name":"liquidity","type":"uint128"},{"indexed":false,"internalType":"int24","name":"tick","type":"int24"}],"name":"Swap","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"int24","name":"newTickSpacing","type":"int24"}],"name":"TickSpacing","type":"event"},{"inputs":[],"name":"activeIncentive","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"int24","name":"bottomTick","type":"int24"},{"internalType":"int24","name":"topTick","type":"int24"},{"internalType":"uint128","name":"amount","type":"uint128"}],"name":"burn","outputs":[{"internalType":"uint256","name":"amount0","type":"uint256"},{"internalType":"uint256","name":"amount1","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"int24","name":"bottomTick","type":"int24"},{"internalType":"int24","name":"topTick","type":"int24"},{"internalType":"uint128","name":"amount0Requested","type":"uint128"},{"internalType":"uint128","name":"amount1Requested","type":"uint128"}],"name":"collect","outputs":[{"internalType":"uint128","name":"amount0","type":"uint128"},{"internalType":"uint128","name":"amount1","type":"uint128"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"dataStorageOperator","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"factory","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount0","type":"uint256"},{"internalType":"uint256","name":"amount1","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"flash","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"int24","name":"bottomTick","type":"int24"},{"internalType":"int24","name":"topTick","type":"int24"}],"name":"getInnerCumulatives","outputs":[{"internalType":"int56","name":"innerTickCumulative","type":"int56"},{"internalType":"uint160","name":"innerSecondsSpentPerLiquidity","type":"uint160"},{"internalType":"uint32","name":"innerSecondsSpent","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint32[]","name":"secondsAgos","type":"uint32[]"}],"name":"getTimepoints","outputs":[{"internalType":"int56[]","name":"tickCumulatives","type":"int56[]"},{"internalType":"uint160[]","name":"secondsPerLiquidityCumulatives","type":"uint160[]"},{"internalType":"uint112[]","name":"volatilityCumulatives","type":"uint112[]"},{"internalType":"uint256[]","name":"volumePerAvgLiquiditys","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"globalState","outputs":[{"internalType":"uint160","name":"price","type":"uint160"},{"internalType":"int24","name":"tick","type":"int24"},{"internalType":"uint16","name":"feeZto","type":"uint16"},{"internalType":"uint16","name":"feeOtz","type":"uint16"},{"internalType":"uint16","name":"timepointIndex","type":"uint16"},{"internalType":"uint8","name":"communityFeeToken0","type":"uint8"},{"internalType":"uint8","name":"communityFeeToken1","type":"uint8"},{"internalType":"bool","name":"unlocked","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint160","name":"initialPrice","type":"uint160"}],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"liquidity","outputs":[{"internalType":"uint128","name":"","type":"uint128"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"liquidityCooldown","outputs":[{"internalType":"uint32","name":"","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxLiquidityPerTick","outputs":[{"internalType":"uint128","name":"","type":"uint128"}],"stateMutability":"pure","type":"function"},{"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"recipient","type":"address"},{"internalType":"int24","name":"bottomTick","type":"int24"},{"internalType":"int24","name":"topTick","type":"int24"},{"internalType":"uint128","name":"liquidityDesired","type":"uint128"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"mint","outputs":[{"internalType":"uint256","name":"amount0","type":"uint256"},{"internalType":"uint256","name":"amount1","type":"uint256"},{"internalType":"uint128","name":"liquidityActual","type":"uint128"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"positions","outputs":[{"internalType":"uint128","name":"liquidity","type":"uint128"},{"internalType":"uint32","name":"lastLiquidityAddTimestamp","type":"uint32"},{"internalType":"uint256","name":"innerFeeGrowth0Token","type":"uint256"},{"internalType":"uint256","name":"innerFeeGrowth1Token","type":"uint256"},{"internalType":"uint128","name":"fees0","type":"uint128"},{"internalType":"uint128","name":"fees1","type":"uint128"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint8","name":"communityFee0","type":"uint8"},{"internalType":"uint8","name":"communityFee1","type":"uint8"}],"name":"setCommunityFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"virtualPoolAddress","type":"address"}],"name":"setIncentive","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint32","name":"newLiquidityCooldown","type":"uint32"}],"name":"setLiquidityCooldown","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"int24","name":"newTickSpacing","type":"int24"}],"name":"setTickSpacing","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"bool","name":"zeroToOne","type":"bool"},{"internalType":"int256","name":"amountRequired","type":"int256"},{"internalType":"uint160","name":"limitSqrtPrice","type":"uint160"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"swap","outputs":[{"internalType":"int256","name":"amount0","type":"int256"},{"internalType":"int256","name":"amount1","type":"int256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"recipient","type":"address"},{"internalType":"bool","name":"zeroToOne","type":"bool"},{"internalType":"int256","name":"amountRequired","type":"int256"},{"internalType":"uint160","name":"limitSqrtPrice","type":"uint160"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"swapSupportingFeeOnInputTokens","outputs":[{"internalType":"int256","name":"amount0","type":"int256"},{"internalType":"int256","name":"amount1","type":"int256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"tickSpacing","outputs":[{"internalType":"int24","name":"","type":"int24"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"int16","name":"","type":"int16"}],"name":"tickTable","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"int24","name":"","type":"int24"}],"name":"ticks","outputs":[{"internalType":"uint128","name":"liquidityTotal","type":"uint128"},{"internalType":"int128","name":"liquidityDelta","type":"int128"},{"internalType":"uint256","name":"outerFeeGrowth0Token","type":"uint256"},{"internalType":"uint256","name":"outerFeeGrowth1Token","type":"uint256"},{"internalType":"int56","name":"outerTickCumulative","type":"int56"},{"internalType":"uint160","name":"outerSecondsPerLiquidity","type":"uint160"},{"internalType":"uint32","name":"outerSecondsSpent","type":"uint32"},{"internalType":"bool","name":"initialized","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"timepoints","outputs":[{"internalType":"bool","name":"initialized","type":"bool"},{"internalType":"uint32","name":"blockTimestamp","type":"uint32"},{"internalType":"int56","name":"tickCumulative","type":"int56"},{"internalType":"uint160","name":"secondsPerLiquidityCumulative","type":"uint160"},{"internalType":"uint88","name":"volatilityCumulative","type":"uint88"},{"internalType":"int24","name":"averageTick","type":"int24"},{"internalType":"uint144","name":"volumePerLiquidityCumulative","type":"uint144"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"token0","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"token1","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalFeeGrowth0Token","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalFeeGrowth1Token","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}]')
contract_address = "0xdEb89DE4bb6ecf5BFeD581EB049308b52d9b2Da7"



address = Web3.to_checksum_address(contract_address)
contract = web3.eth.contract( address = address, abi = abi )

address_token0 = contract.functions.token0().call()  # wstETH 0x5979D7b546E38E414F7E9822514be443A4800529
address_token1 = contract.functions.token1().call()  # WETH 0x82aF49447D8a07e3bd95BD0d56f35241523fBab1

decimals_0 = 18
decimals_1 = 18

block_identifier_ = 232487025

#  active tick, status, bin counter, and protocol fee ratio
price , tick , feeZto , feeOtz , timepointIndex , communityFeeToken0 , communityFeeToken1 , unlocked   = contract.functions.globalState().call(block_identifier = block_identifier_) 

1.0001**tick

####################################################
# MIM/USDC
####################################################

contract_address = "0x0e7ac13617cc1a289b222e4602bdaaa53ea4dc61"



address = Web3.to_checksum_address(contract_address)
contract = web3.eth.contract( address = address, abi = abi )

address_token0 = contract.functions.token0().call()  # USDC 0xaf88d065e77c8cC2239327C5EDb3A432268e5831
address_token1 = contract.functions.token1().call()  # MIM 0xFEa7a6a0B346362BF88A9e4A88416B77a57D6c2A

decimals_0 = 6
decimals_1 = 18

block_identifier_ = 232487025

#  active tick, status, bin counter, and protocol fee ratio
price , tick , feeZto , feeOtz , timepointIndex , communityFeeToken0 , communityFeeToken1 , unlocked   = contract.functions.globalState().call() 

1.0001**tick* 10**(-decimals_1)*10**(decimals_0)


####################################################
# LUSD/USDC
####################################################

contract_address = "0x3d7412e255c04239285cAd57f82220D07D6874B0"



address = Web3.to_checksum_address(contract_address)
contract = web3.eth.contract( address = address, abi = abi )

address_token0 = contract.functions.token0().call()  # LUSD 0x93b346b6BC2548dA6A1E7d98E9a421B42541425b
address_token1 = contract.functions.token1().call()  # USDC 0xaf88d065e77c8cC2239327C5EDb3A432268e5831

decimals_0 = 18
decimals_1 = 6

block_identifier_ = 232487025

#  active tick, status, bin counter, and protocol fee ratio
price , tick , feeZto , feeOtz , timepointIndex , communityFeeToken0 , communityFeeToken1 , unlocked   = contract.functions.globalState().call() 

1.0001**tick* 10**(-decimals_1)*10**(decimals_0)





tickSpacing = contract.functions.tickSpacing().call()

p_l = 1.0001**(tick_lower*tickSpacing)
p_u = 1.0001**( (tick_lower+1)*tickSpacing)



state_price = 1/( 1.0001**tick_lower* 10**(-decimals_1) / 10**(-decimals_0) )

#%%
# V1

abi = json.loads('[{"inputs":[{"internalType":"contract IPool","name":"pool","type":"address"}],"name":"activeTickLiquidity","outputs":[{"internalType":"uint256","name":"sqrtPrice","type":"uint256"},{"internalType":"uint256","name":"liquidity","type":"uint256"},{"internalType":"uint256","name":"reserveA","type":"uint256"},{"internalType":"uint256","name":"reserveB","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes","name":"path","type":"bytes"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"bool","name":"exactOutput","type":"bool"}],"name":"calculateMultihopSwap","outputs":[{"internalType":"uint256","name":"returnAmount","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"contract IPool","name":"pool","type":"address"},{"internalType":"uint128","name":"amount","type":"uint128"},{"internalType":"bool","name":"tokenAIn","type":"bool"},{"internalType":"bool","name":"exactOutput","type":"bool"},{"internalType":"uint256","name":"sqrtPriceLimit","type":"uint256"}],"name":"calculateSwap","outputs":[{"internalType":"uint256","name":"returnAmount","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"contract IPool","name":"pool","type":"address"},{"internalType":"uint128","name":"startBinIndex","type":"uint128"},{"internalType":"uint128","name":"endBinIndex","type":"uint128"}],"name":"getActiveBins","outputs":[{"components":[{"internalType":"uint128","name":"id","type":"uint128"},{"internalType":"uint8","name":"kind","type":"uint8"},{"internalType":"int32","name":"lowerTick","type":"int32"},{"internalType":"uint128","name":"reserveA","type":"uint128"},{"internalType":"uint128","name":"reserveB","type":"uint128"},{"internalType":"uint128","name":"mergeId","type":"uint128"}],"internalType":"struct IPoolInformation.BinInfo[]","name":"bins","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"contract IPool","name":"pool","type":"address"},{"internalType":"uint128","name":"binId","type":"uint128"}],"name":"getBinDepth","outputs":[{"internalType":"uint256","name":"depth","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"contract IPool","name":"pool","type":"address"},{"internalType":"int32","name":"tick","type":"int32"}],"name":"getBinsAtTick","outputs":[{"components":[{"internalType":"uint128","name":"reserveA","type":"uint128"},{"internalType":"uint128","name":"reserveB","type":"uint128"},{"internalType":"uint128","name":"mergeBinBalance","type":"uint128"},{"internalType":"uint128","name":"mergeId","type":"uint128"},{"internalType":"uint128","name":"totalSupply","type":"uint128"},{"internalType":"uint8","name":"kind","type":"uint8"},{"internalType":"int32","name":"lowerTick","type":"int32"}],"internalType":"struct IPool.BinState[]","name":"bins","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"contract IPool","name":"pool","type":"address"}],"name":"getSqrtPrice","outputs":[{"internalType":"uint256","name":"sqrtPrice","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"contract IPool","name":"pool","type":"address"},{"internalType":"int32","name":"tick","type":"int32"}],"name":"tickLiquidity","outputs":[{"internalType":"uint256","name":"sqrtPrice","type":"uint256"},{"internalType":"uint256","name":"liquidity","type":"uint256"},{"internalType":"uint256","name":"reserveA","type":"uint256"},{"internalType":"uint256","name":"reserveB","type":"uint256"}],"stateMutability":"view","type":"function"}]')

contract_address = "0x0087D11551437c3964Dddf0F4FA58836c5C5d949"

address = Web3.to_checksum_address(contract_address)
contract = web3.eth.contract( address = address, abi = abi )

pool_address = "0x0eb1c92f9f5ec9d817968afddb4b46c564cdedbe"   # wstETH/ETH
pool_address = "0xa51822839bfa4685b27ad60305264a37eae28a68"   # OETH
pool_address = Web3.to_checksum_address(pool_address) 
sqrtPrice, liquidity, reserveA, reserveB = contract.functions.activeTickLiquidity(pool_address).call()

(reserveA + liquidity*sqrt(p_l))/(reserveB + liquidity/sqrt(p_u))
(reserveA + liquidity*sqrt(p_l))/(reserveB + liquidity/sqrt(p_u))

sqrtPrice**2


854405667827147199
1/(sqrtPrice**2/10**36)
#%%
# V2

#abi = json.loads('[{"inputs":[{"internalType":"contract IPool","name":"pool","type":"address"}],"name":"activeTickLiquidity","outputs":[{"internalType":"uint256","name":"sqrtPrice","type":"uint256"},{"internalType":"uint256","name":"liquidity","type":"uint256"},{"internalType":"uint256","name":"reserveA","type":"uint256"},{"internalType":"uint256","name":"reserveB","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes","name":"path","type":"bytes"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"bool","name":"exactOutput","type":"bool"}],"name":"calculateMultihopSwap","outputs":[{"internalType":"uint256","name":"returnAmount","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"contract IPool","name":"pool","type":"address"},{"internalType":"uint128","name":"amount","type":"uint128"},{"internalType":"bool","name":"tokenAIn","type":"bool"},{"internalType":"bool","name":"exactOutput","type":"bool"},{"internalType":"uint256","name":"sqrtPriceLimit","type":"uint256"}],"name":"calculateSwap","outputs":[{"internalType":"uint256","name":"returnAmount","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"contract IPool","name":"pool","type":"address"},{"internalType":"uint128","name":"startBinIndex","type":"uint128"},{"internalType":"uint128","name":"endBinIndex","type":"uint128"}],"name":"getActiveBins","outputs":[{"components":[{"internalType":"uint128","name":"id","type":"uint128"},{"internalType":"uint8","name":"kind","type":"uint8"},{"internalType":"int32","name":"lowerTick","type":"int32"},{"internalType":"uint128","name":"reserveA","type":"uint128"},{"internalType":"uint128","name":"reserveB","type":"uint128"},{"internalType":"uint128","name":"mergeId","type":"uint128"}],"internalType":"struct IPoolInformation.BinInfo[]","name":"bins","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"contract IPool","name":"pool","type":"address"},{"internalType":"uint128","name":"binId","type":"uint128"}],"name":"getBinDepth","outputs":[{"internalType":"uint256","name":"depth","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"contract IPool","name":"pool","type":"address"},{"internalType":"int32","name":"tick","type":"int32"}],"name":"getBinsAtTick","outputs":[{"components":[{"internalType":"uint128","name":"reserveA","type":"uint128"},{"internalType":"uint128","name":"reserveB","type":"uint128"},{"internalType":"uint128","name":"mergeBinBalance","type":"uint128"},{"internalType":"uint128","name":"mergeId","type":"uint128"},{"internalType":"uint128","name":"totalSupply","type":"uint128"},{"internalType":"uint8","name":"kind","type":"uint8"},{"internalType":"int32","name":"lowerTick","type":"int32"}],"internalType":"struct IPool.BinState[]","name":"bins","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"contract IPool","name":"pool","type":"address"}],"name":"getSqrtPrice","outputs":[{"internalType":"uint256","name":"sqrtPrice","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"contract IPool","name":"pool","type":"address"},{"internalType":"int32","name":"tick","type":"int32"}],"name":"tickLiquidity","outputs":[{"internalType":"uint256","name":"sqrtPrice","type":"uint256"},{"internalType":"uint256","name":"liquidity","type":"uint256"},{"internalType":"uint256","name":"reserveA","type":"uint256"},{"internalType":"uint256","name":"reserveB","type":"uint256"}],"stateMutability":"view","type":"function"}]')

abi = json.loads('[{"inputs":[{"internalType":"uint256","name":"targetSqrtPrice","type":"uint256"},{"internalType":"uint256","name":"sqrtLowerTickPrice","type":"uint256"},{"internalType":"uint256","name":"sqrtUpperTickPrice","type":"uint256"}],"name":"LensTargetPriceOutOfBounds","type":"error"},{"inputs":[{"internalType":"bool","name":"targetIsA","type":"bool"},{"internalType":"uint256","name":"deltaA","type":"uint256"},{"internalType":"uint256","name":"deltaB","type":"uint256"}],"name":"LensTargetingTokenWithNoDelta","type":"error"},{"inputs":[{"internalType":"uint256","name":"relativeLiquidityAmount","type":"uint256"},{"internalType":"uint256","name":"deltaA","type":"uint256"},{"internalType":"uint256","name":"deltaB","type":"uint256"}],"name":"LensTooLittleLiquidity","type":"error"},{"inputs":[],"name":"LiquidityUtilitiesFailedToFindDeltaAmounts","type":"error"},{"inputs":[{"internalType":"uint256","name":"initialTargetB","type":"uint256"},{"internalType":"uint256","name":"deltaLpBalance","type":"uint256"},{"internalType":"uint256","name":"minimumRequiredLpBalance","type":"uint256"}],"name":"LiquidityUtilitiesInitialTargetBTooSmall","type":"error"},{"inputs":[],"name":"LiquidityUtilitiesNoSwapLiquidity","type":"error"},{"inputs":[{"internalType":"uint256","name":"targetSqrtPrice","type":"uint256"},{"internalType":"uint256","name":"sqrtLowerTickPrice","type":"uint256"},{"internalType":"uint256","name":"sqrtUpperTickPrice","type":"uint256"}],"name":"LiquidityUtilitiesTargetPriceOutOfBounds","type":"error"},{"inputs":[],"name":"MathOverflowedMulDiv","type":"error"},{"inputs":[{"internalType":"uint8","name":"bits","type":"uint8"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"SafeCastOverflowedUintDowncast","type":"error"},{"inputs":[{"internalType":"int256","name":"tick","type":"int256"}],"name":"TickMaxExceeded","type":"error"},{"inputs":[{"components":[{"internalType":"contract IMaverickV2Pool","name":"pool","type":"address"},{"internalType":"uint8","name":"kind","type":"uint8"},{"internalType":"int32[]","name":"ticks","type":"int32[]"},{"internalType":"uint128[]","name":"relativeLiquidityAmounts","type":"uint128[]"},{"components":[{"internalType":"uint256","name":"slippageFactorD18","type":"uint256"},{"internalType":"uint256","name":"numberOfPriceBreaksPerSide","type":"uint256"},{"internalType":"uint256","name":"targetAmount","type":"uint256"},{"internalType":"bool","name":"targetIsA","type":"bool"}],"internalType":"struct IMaverickV2PoolLens.AddParamsSpecification","name":"addSpec","type":"tuple"}],"internalType":"struct IMaverickV2PoolLens.AddParamsViewInputs","name":"params","type":"tuple"}],"name":"getAddLiquidityParams","outputs":[{"internalType":"bytes","name":"packedSqrtPriceBreaks","type":"bytes"},{"internalType":"bytes[]","name":"packedArgs","type":"bytes[]"},{"internalType":"uint88[]","name":"sqrtPriceBreaks","type":"uint88[]"},{"components":[{"internalType":"uint8","name":"kind","type":"uint8"},{"internalType":"int32[]","name":"ticks","type":"int32[]"},{"internalType":"uint128[]","name":"amounts","type":"uint128[]"}],"internalType":"struct IMaverickV2Pool.AddLiquidityParams[]","name":"addParams","type":"tuple[]"},{"components":[{"internalType":"uint256","name":"deltaAOut","type":"uint256"},{"internalType":"uint256","name":"deltaBOut","type":"uint256"},{"internalType":"uint256[]","name":"deltaAs","type":"uint256[]"},{"internalType":"uint256[]","name":"deltaBs","type":"uint256[]"}],"internalType":"struct IMaverickV2PoolLens.TickDeltas[]","name":"tickDeltas","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"contract IMaverickV2BoostedPosition","name":"boostedPosition","type":"address"},{"components":[{"internalType":"uint256","name":"slippageFactorD18","type":"uint256"},{"internalType":"uint256","name":"numberOfPriceBreaksPerSide","type":"uint256"},{"internalType":"uint256","name":"targetAmount","type":"uint256"},{"internalType":"bool","name":"targetIsA","type":"bool"}],"internalType":"struct IMaverickV2PoolLens.AddParamsSpecification","name":"addSpec","type":"tuple"}],"name":"getAddLiquidityParamsForBoostedPosition","outputs":[{"internalType":"bytes","name":"packedSqrtPriceBreaks","type":"bytes"},{"internalType":"bytes[]","name":"packedArgs","type":"bytes[]"},{"internalType":"uint88[]","name":"sqrtPriceBreaks","type":"uint88[]"},{"components":[{"internalType":"uint8","name":"kind","type":"uint8"},{"internalType":"int32[]","name":"ticks","type":"int32[]"},{"internalType":"uint128[]","name":"amounts","type":"uint128[]"}],"internalType":"struct IMaverickV2Pool.AddLiquidityParams[]","name":"addParams","type":"tuple[]"},{"components":[{"internalType":"uint256","name":"deltaAOut","type":"uint256"},{"internalType":"uint256","name":"deltaBOut","type":"uint256"},{"internalType":"uint256[]","name":"deltaAs","type":"uint256[]"},{"internalType":"uint256[]","name":"deltaBs","type":"uint256[]"}],"internalType":"struct IMaverickV2PoolLens.TickDeltas[]","name":"tickDeltas","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"components":[{"internalType":"contract IMaverickV2Pool","name":"pool","type":"address"},{"internalType":"uint32[]","name":"binIds","type":"uint32[]"},{"internalType":"uint128[]","name":"ratios","type":"uint128[]"},{"internalType":"uint8","name":"kind","type":"uint8"}],"internalType":"struct IMaverickV2PoolLens.BoostedPositionSpecification","name":"bpSpec","type":"tuple"},{"components":[{"internalType":"uint256","name":"slippageFactorD18","type":"uint256"},{"internalType":"uint256","name":"numberOfPriceBreaksPerSide","type":"uint256"},{"internalType":"uint256","name":"targetAmount","type":"uint256"},{"internalType":"bool","name":"targetIsA","type":"bool"}],"internalType":"struct IMaverickV2PoolLens.AddParamsSpecification","name":"addSpec","type":"tuple"}],"name":"getCreateBoostedPositionParams","outputs":[{"internalType":"bytes","name":"packedSqrtPriceBreaks","type":"bytes"},{"internalType":"bytes[]","name":"packedArgs","type":"bytes[]"},{"internalType":"uint88[]","name":"sqrtPriceBreaks","type":"uint88[]"},{"components":[{"internalType":"uint8","name":"kind","type":"uint8"},{"internalType":"int32[]","name":"ticks","type":"int32[]"},{"internalType":"uint128[]","name":"amounts","type":"uint128[]"}],"internalType":"struct IMaverickV2Pool.AddLiquidityParams[]","name":"addParams","type":"tuple[]"},{"components":[{"internalType":"uint256","name":"deltaAOut","type":"uint256"},{"internalType":"uint256","name":"deltaBOut","type":"uint256"},{"internalType":"uint256[]","name":"deltaAs","type":"uint256[]"},{"internalType":"uint256[]","name":"deltaBs","type":"uint256[]"}],"internalType":"struct IMaverickV2PoolLens.TickDeltas[]","name":"tickDeltas","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"components":[{"internalType":"uint64","name":"feeAIn","type":"uint64"},{"internalType":"uint64","name":"feeBIn","type":"uint64"},{"internalType":"uint16","name":"tickSpacing","type":"uint16"},{"internalType":"uint32","name":"lookback","type":"uint32"},{"internalType":"contract IERC20","name":"tokenA","type":"address"},{"internalType":"contract IERC20","name":"tokenB","type":"address"},{"internalType":"int32","name":"activeTick","type":"int32"},{"internalType":"uint8","name":"kinds","type":"uint8"},{"internalType":"uint256","name":"initialTargetB","type":"uint256"},{"internalType":"uint256","name":"sqrtPrice","type":"uint256"},{"internalType":"uint8","name":"kind","type":"uint8"},{"internalType":"int32[]","name":"ticks","type":"int32[]"},{"internalType":"uint128[]","name":"relativeLiquidityAmounts","type":"uint128[]"},{"internalType":"uint256","name":"targetAmount","type":"uint256"},{"internalType":"bool","name":"targetIsA","type":"bool"}],"internalType":"struct IMaverickV2PoolLens.CreateAndAddParamsViewInputs","name":"params","type":"tuple"},{"internalType":"contract IMaverickV2Factory","name":"factory","type":"address"}],"name":"getCreatePoolAtPriceAndAddLiquidityParams","outputs":[{"components":[{"internalType":"uint64","name":"feeAIn","type":"uint64"},{"internalType":"uint64","name":"feeBIn","type":"uint64"},{"internalType":"uint16","name":"tickSpacing","type":"uint16"},{"internalType":"uint32","name":"lookback","type":"uint32"},{"internalType":"contract IERC20","name":"tokenA","type":"address"},{"internalType":"contract IERC20","name":"tokenB","type":"address"},{"internalType":"int32","name":"activeTick","type":"int32"},{"internalType":"uint8","name":"kinds","type":"uint8"},{"components":[{"internalType":"uint8","name":"kind","type":"uint8"},{"internalType":"int32[]","name":"ticks","type":"int32[]"},{"internalType":"uint128[]","name":"amounts","type":"uint128[]"}],"internalType":"struct IMaverickV2Pool.AddLiquidityParams","name":"donateParams","type":"tuple"},{"internalType":"uint256","name":"swapAmount","type":"uint256"},{"components":[{"internalType":"uint8","name":"kind","type":"uint8"},{"internalType":"int32[]","name":"ticks","type":"int32[]"},{"internalType":"uint128[]","name":"amounts","type":"uint128[]"}],"internalType":"struct IMaverickV2Pool.AddLiquidityParams","name":"addParams","type":"tuple"},{"internalType":"bytes[]","name":"packedAddParams","type":"bytes[]"},{"internalType":"uint256","name":"deltaAOut","type":"uint256"},{"internalType":"uint256","name":"deltaBOut","type":"uint256"},{"internalType":"uint256","name":"preAddReserveA","type":"uint256"},{"internalType":"uint256","name":"preAddReserveB","type":"uint256"}],"internalType":"struct IMaverickV2PoolLens.CreateAndAddParamsInputs","name":"output","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"contract IMaverickV2Pool","name":"pool","type":"address"},{"internalType":"uint32","name":"binStart","type":"uint32"},{"internalType":"uint32","name":"binEnd","type":"uint32"}],"name":"getFullPoolState","outputs":[{"components":[{"components":[{"internalType":"uint128","name":"reserveA","type":"uint128"},{"internalType":"uint128","name":"reserveB","type":"uint128"},{"internalType":"uint128","name":"totalSupply","type":"uint128"},{"internalType":"uint32[4]","name":"binIdsByTick","type":"uint32[4]"}],"internalType":"struct IMaverickV2Pool.TickState[]","name":"tickStateMapping","type":"tuple[]"},{"components":[{"internalType":"uint128","name":"mergeBinBalance","type":"uint128"},{"internalType":"uint128","name":"tickBalance","type":"uint128"},{"internalType":"uint128","name":"totalSupply","type":"uint128"},{"internalType":"uint8","name":"kind","type":"uint8"},{"internalType":"int32","name":"tick","type":"int32"},{"internalType":"uint32","name":"mergeId","type":"uint32"}],"internalType":"struct IMaverickV2Pool.BinState[]","name":"binStateMapping","type":"tuple[]"},{"components":[{"internalType":"uint128[4]","name":"values","type":"uint128[4]"}],"internalType":"struct IMaverickV2PoolLens.BinPositionKinds[]","name":"binIdByTickKindMapping","type":"tuple[]"},{"components":[{"internalType":"uint128","name":"reserveA","type":"uint128"},{"internalType":"uint128","name":"reserveB","type":"uint128"},{"internalType":"int64","name":"lastTwaD8","type":"int64"},{"internalType":"int64","name":"lastLogPriceD8","type":"int64"},{"internalType":"uint40","name":"lastTimestamp","type":"uint40"},{"internalType":"int32","name":"activeTick","type":"int32"},{"internalType":"bool","name":"isLocked","type":"bool"},{"internalType":"uint32","name":"binCounter","type":"uint32"},{"internalType":"uint8","name":"protocolFeeRatioD3","type":"uint8"}],"internalType":"struct IMaverickV2Pool.State","name":"state","type":"tuple"},{"components":[{"internalType":"uint256","name":"amountA","type":"uint256"},{"internalType":"uint256","name":"amountB","type":"uint256"}],"internalType":"struct IMaverickV2PoolLens.Reserves","name":"protocolFees","type":"tuple"}],"internalType":"struct IMaverickV2PoolLens.PoolState","name":"poolState","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"contract IMaverickV2Pool","name":"pool","type":"address"}],"name":"getPoolPrice","outputs":[{"internalType":"uint256","name":"price","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"contract IMaverickV2Pool","name":"pool","type":"address"}],"name":"getPoolSqrtPrice","outputs":[{"internalType":"uint256","name":"sqrtPrice","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"contract IMaverickV2Pool","name":"pool","type":"address"},{"internalType":"int32","name":"tick","type":"int32"}],"name":"getTickSqrtPriceAndL","outputs":[{"internalType":"uint256","name":"sqrtPrice","type":"uint256"},{"internalType":"uint256","name":"liquidity","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"contract IMaverickV2Pool","name":"pool","type":"address"},{"internalType":"int32","name":"tickStart","type":"int32"},{"internalType":"int32","name":"tickEnd","type":"int32"}],"name":"getTicks","outputs":[{"internalType":"int32[]","name":"ticks","type":"int32[]"},{"components":[{"internalType":"uint128","name":"reserveA","type":"uint128"},{"internalType":"uint128","name":"reserveB","type":"uint128"},{"internalType":"uint128","name":"totalSupply","type":"uint128"},{"internalType":"uint32[4]","name":"binIdsByTick","type":"uint32[4]"}],"internalType":"struct IMaverickV2Pool.TickState[]","name":"tickStates","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"contract IMaverickV2Pool","name":"pool","type":"address"},{"internalType":"int32","name":"tickRadius","type":"int32"}],"name":"getTicksAroundActive","outputs":[{"internalType":"int32[]","name":"ticks","type":"int32[]"},{"components":[{"internalType":"uint128","name":"reserveA","type":"uint128"},{"internalType":"uint128","name":"reserveB","type":"uint128"},{"internalType":"uint128","name":"totalSupply","type":"uint128"},{"internalType":"uint32[4]","name":"binIdsByTick","type":"uint32[4]"}],"internalType":"struct IMaverickV2Pool.TickState[]","name":"tickStates","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"contract IMaverickV2Pool","name":"pool","type":"address"},{"internalType":"int32","name":"tickRadius","type":"int32"}],"name":"getTicksAroundActiveWLiquidity","outputs":[{"internalType":"int32[]","name":"ticks","type":"int32[]"},{"components":[{"internalType":"uint128","name":"reserveA","type":"uint128"},{"internalType":"uint128","name":"reserveB","type":"uint128"},{"internalType":"uint128","name":"totalSupply","type":"uint128"},{"internalType":"uint32[4]","name":"binIdsByTick","type":"uint32[4]"}],"internalType":"struct IMaverickV2Pool.TickState[]","name":"tickStates","type":"tuple[]"},{"internalType":"uint256[]","name":"liquidities","type":"uint256[]"},{"internalType":"uint256[]","name":"sqrtLowerTickPrices","type":"uint256[]"},{"internalType":"uint256[]","name":"sqrtUpperTickPrices","type":"uint256[]"},{"components":[{"internalType":"uint128","name":"reserveA","type":"uint128"},{"internalType":"uint128","name":"reserveB","type":"uint128"},{"internalType":"int64","name":"lastTwaD8","type":"int64"},{"internalType":"int64","name":"lastLogPriceD8","type":"int64"},{"internalType":"uint40","name":"lastTimestamp","type":"uint40"},{"internalType":"int32","name":"activeTick","type":"int32"},{"internalType":"bool","name":"isLocked","type":"bool"},{"internalType":"uint32","name":"binCounter","type":"uint32"},{"internalType":"uint8","name":"protocolFeeRatioD3","type":"uint8"}],"internalType":"struct IMaverickV2Pool.State","name":"poolState","type":"tuple"},{"internalType":"uint256","name":"sqrtPrice","type":"uint256"},{"internalType":"uint256","name":"feeAIn","type":"uint256"},{"internalType":"uint256","name":"feeBIn","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"contract IMaverickV2Pool","name":"pool","type":"address"}],"name":"tokenScales","outputs":[{"internalType":"uint256","name":"tokenAScale","type":"uint256"},{"internalType":"uint256","name":"tokenBScale","type":"uint256"}],"stateMutability":"view","type":"function"}]')

contract_address = "0x942646b0A8B42Af1e1044439013436a9a3e080b5"

address = Web3.to_checksum_address(contract_address)
contract = web3.eth.contract( address = address, abi = abi )

pool_address = "0x68875ad4dC276527790b3a80D397e04abF44344c"
pool_address = Web3.to_checksum_address(pool_address) 
contract.functions.getPoolPrice(pool_address).call()




#%%
####################################################
# Uniswap V3
####################################################

## DAI/USDC
contract_address = "0x6c6bc977e13df9b0de53b251522280bb72383700"  #DAI/USDC
decimals_0 = 18
decimals_1 = 6


abi = json.loads('[{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"int24","name":"tickLower","type":"int24"},{"indexed":true,"internalType":"int24","name":"tickUpper","type":"int24"},{"indexed":false,"internalType":"uint128","name":"amount","type":"uint128"},{"indexed":false,"internalType":"uint256","name":"amount0","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount1","type":"uint256"}],"name":"Burn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":false,"internalType":"address","name":"recipient","type":"address"},{"indexed":true,"internalType":"int24","name":"tickLower","type":"int24"},{"indexed":true,"internalType":"int24","name":"tickUpper","type":"int24"},{"indexed":false,"internalType":"uint128","name":"amount0","type":"uint128"},{"indexed":false,"internalType":"uint128","name":"amount1","type":"uint128"}],"name":"Collect","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"sender","type":"address"},{"indexed":true,"internalType":"address","name":"recipient","type":"address"},{"indexed":false,"internalType":"uint128","name":"amount0","type":"uint128"},{"indexed":false,"internalType":"uint128","name":"amount1","type":"uint128"}],"name":"CollectProtocol","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"sender","type":"address"},{"indexed":true,"internalType":"address","name":"recipient","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount0","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount1","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"paid0","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"paid1","type":"uint256"}],"name":"Flash","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint16","name":"observationCardinalityNextOld","type":"uint16"},{"indexed":false,"internalType":"uint16","name":"observationCardinalityNextNew","type":"uint16"}],"name":"IncreaseObservationCardinalityNext","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint160","name":"sqrtPriceX96","type":"uint160"},{"indexed":false,"internalType":"int24","name":"tick","type":"int24"}],"name":"Initialize","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"sender","type":"address"},{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"int24","name":"tickLower","type":"int24"},{"indexed":true,"internalType":"int24","name":"tickUpper","type":"int24"},{"indexed":false,"internalType":"uint128","name":"amount","type":"uint128"},{"indexed":false,"internalType":"uint256","name":"amount0","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount1","type":"uint256"}],"name":"Mint","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint8","name":"feeProtocol0Old","type":"uint8"},{"indexed":false,"internalType":"uint8","name":"feeProtocol1Old","type":"uint8"},{"indexed":false,"internalType":"uint8","name":"feeProtocol0New","type":"uint8"},{"indexed":false,"internalType":"uint8","name":"feeProtocol1New","type":"uint8"}],"name":"SetFeeProtocol","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"sender","type":"address"},{"indexed":true,"internalType":"address","name":"recipient","type":"address"},{"indexed":false,"internalType":"int256","name":"amount0","type":"int256"},{"indexed":false,"internalType":"int256","name":"amount1","type":"int256"},{"indexed":false,"internalType":"uint160","name":"sqrtPriceX96","type":"uint160"},{"indexed":false,"internalType":"uint128","name":"liquidity","type":"uint128"},{"indexed":false,"internalType":"int24","name":"tick","type":"int24"}],"name":"Swap","type":"event"},{"inputs":[{"internalType":"int24","name":"tickLower","type":"int24"},{"internalType":"int24","name":"tickUpper","type":"int24"},{"internalType":"uint128","name":"amount","type":"uint128"}],"name":"burn","outputs":[{"internalType":"uint256","name":"amount0","type":"uint256"},{"internalType":"uint256","name":"amount1","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"int24","name":"tickLower","type":"int24"},{"internalType":"int24","name":"tickUpper","type":"int24"},{"internalType":"uint128","name":"amount0Requested","type":"uint128"},{"internalType":"uint128","name":"amount1Requested","type":"uint128"}],"name":"collect","outputs":[{"internalType":"uint128","name":"amount0","type":"uint128"},{"internalType":"uint128","name":"amount1","type":"uint128"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint128","name":"amount0Requested","type":"uint128"},{"internalType":"uint128","name":"amount1Requested","type":"uint128"}],"name":"collectProtocol","outputs":[{"internalType":"uint128","name":"amount0","type":"uint128"},{"internalType":"uint128","name":"amount1","type":"uint128"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"factory","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"fee","outputs":[{"internalType":"uint24","name":"","type":"uint24"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeGrowthGlobal0X128","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeGrowthGlobal1X128","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount0","type":"uint256"},{"internalType":"uint256","name":"amount1","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"flash","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint16","name":"observationCardinalityNext","type":"uint16"}],"name":"increaseObservationCardinalityNext","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint160","name":"sqrtPriceX96","type":"uint160"}],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"liquidity","outputs":[{"internalType":"uint128","name":"","type":"uint128"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxLiquidityPerTick","outputs":[{"internalType":"uint128","name":"","type":"uint128"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"int24","name":"tickLower","type":"int24"},{"internalType":"int24","name":"tickUpper","type":"int24"},{"internalType":"uint128","name":"amount","type":"uint128"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"mint","outputs":[{"internalType":"uint256","name":"amount0","type":"uint256"},{"internalType":"uint256","name":"amount1","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"observations","outputs":[{"internalType":"uint32","name":"blockTimestamp","type":"uint32"},{"internalType":"int56","name":"tickCumulative","type":"int56"},{"internalType":"uint160","name":"secondsPerLiquidityCumulativeX128","type":"uint160"},{"internalType":"bool","name":"initialized","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint32[]","name":"secondsAgos","type":"uint32[]"}],"name":"observe","outputs":[{"internalType":"int56[]","name":"tickCumulatives","type":"int56[]"},{"internalType":"uint160[]","name":"secondsPerLiquidityCumulativeX128s","type":"uint160[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"positions","outputs":[{"internalType":"uint128","name":"liquidity","type":"uint128"},{"internalType":"uint256","name":"feeGrowthInside0LastX128","type":"uint256"},{"internalType":"uint256","name":"feeGrowthInside1LastX128","type":"uint256"},{"internalType":"uint128","name":"tokensOwed0","type":"uint128"},{"internalType":"uint128","name":"tokensOwed1","type":"uint128"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"protocolFees","outputs":[{"internalType":"uint128","name":"token0","type":"uint128"},{"internalType":"uint128","name":"token1","type":"uint128"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint8","name":"feeProtocol0","type":"uint8"},{"internalType":"uint8","name":"feeProtocol1","type":"uint8"}],"name":"setFeeProtocol","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"slot0","outputs":[{"internalType":"uint160","name":"sqrtPriceX96","type":"uint160"},{"internalType":"int24","name":"tick","type":"int24"},{"internalType":"uint16","name":"observationIndex","type":"uint16"},{"internalType":"uint16","name":"observationCardinality","type":"uint16"},{"internalType":"uint16","name":"observationCardinalityNext","type":"uint16"},{"internalType":"uint8","name":"feeProtocol","type":"uint8"},{"internalType":"bool","name":"unlocked","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"int24","name":"tickLower","type":"int24"},{"internalType":"int24","name":"tickUpper","type":"int24"}],"name":"snapshotCumulativesInside","outputs":[{"internalType":"int56","name":"tickCumulativeInside","type":"int56"},{"internalType":"uint160","name":"secondsPerLiquidityInsideX128","type":"uint160"},{"internalType":"uint32","name":"secondsInside","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"bool","name":"zeroForOne","type":"bool"},{"internalType":"int256","name":"amountSpecified","type":"int256"},{"internalType":"uint160","name":"sqrtPriceLimitX96","type":"uint160"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"swap","outputs":[{"internalType":"int256","name":"amount0","type":"int256"},{"internalType":"int256","name":"amount1","type":"int256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"int16","name":"","type":"int16"}],"name":"tickBitmap","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"tickSpacing","outputs":[{"internalType":"int24","name":"","type":"int24"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"int24","name":"","type":"int24"}],"name":"ticks","outputs":[{"internalType":"uint128","name":"liquidityGross","type":"uint128"},{"internalType":"int128","name":"liquidityNet","type":"int128"},{"internalType":"uint256","name":"feeGrowthOutside0X128","type":"uint256"},{"internalType":"uint256","name":"feeGrowthOutside1X128","type":"uint256"},{"internalType":"int56","name":"tickCumulativeOutside","type":"int56"},{"internalType":"uint160","name":"secondsPerLiquidityOutsideX128","type":"uint160"},{"internalType":"uint32","name":"secondsOutside","type":"uint32"},{"internalType":"bool","name":"initialized","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"token0","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"token1","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"}]')
address = Web3.to_checksum_address(contract_address)
contract = web3.eth.contract(address = address, abi = abi )


address_token0 = contract.functions.token0().call()  # DAI 0x6B175474E89094C44Da98b954EedeAC495271d0F
address_token1 = contract.functions.token1().call()  # USDC 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48
decimals_0 = 18
decimals_1 = 6

#totalSupply = contract.functions.totalSupply().call()
tick = contract.functions.slot0().call()[1] 
sqrtPrice = contract.functions.slot0().call()[0]
rate_0_1_approx = 1.0001**tick* 10**(-decimals_1) / 10**(-decimals_0)

rate_0_1 =(sqrtPrice/2**96)**2*10**(decimals_0-decimals_1)
print(f'the price is {rate_0_1}')  # 9 digits


#%%
####################################################
# Uniswap V3
####################################################

contract_address = "0x109830a1aaad605bbf02a9dfa7b0b92ec2fb7daa"  #wstETH/WETH



abi = json.loads('[{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"int24","name":"tickLower","type":"int24"},{"indexed":true,"internalType":"int24","name":"tickUpper","type":"int24"},{"indexed":false,"internalType":"uint128","name":"amount","type":"uint128"},{"indexed":false,"internalType":"uint256","name":"amount0","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount1","type":"uint256"}],"name":"Burn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":false,"internalType":"address","name":"recipient","type":"address"},{"indexed":true,"internalType":"int24","name":"tickLower","type":"int24"},{"indexed":true,"internalType":"int24","name":"tickUpper","type":"int24"},{"indexed":false,"internalType":"uint128","name":"amount0","type":"uint128"},{"indexed":false,"internalType":"uint128","name":"amount1","type":"uint128"}],"name":"Collect","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"sender","type":"address"},{"indexed":true,"internalType":"address","name":"recipient","type":"address"},{"indexed":false,"internalType":"uint128","name":"amount0","type":"uint128"},{"indexed":false,"internalType":"uint128","name":"amount1","type":"uint128"}],"name":"CollectProtocol","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"sender","type":"address"},{"indexed":true,"internalType":"address","name":"recipient","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount0","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount1","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"paid0","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"paid1","type":"uint256"}],"name":"Flash","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint16","name":"observationCardinalityNextOld","type":"uint16"},{"indexed":false,"internalType":"uint16","name":"observationCardinalityNextNew","type":"uint16"}],"name":"IncreaseObservationCardinalityNext","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint160","name":"sqrtPriceX96","type":"uint160"},{"indexed":false,"internalType":"int24","name":"tick","type":"int24"}],"name":"Initialize","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"sender","type":"address"},{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"int24","name":"tickLower","type":"int24"},{"indexed":true,"internalType":"int24","name":"tickUpper","type":"int24"},{"indexed":false,"internalType":"uint128","name":"amount","type":"uint128"},{"indexed":false,"internalType":"uint256","name":"amount0","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount1","type":"uint256"}],"name":"Mint","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint8","name":"feeProtocol0Old","type":"uint8"},{"indexed":false,"internalType":"uint8","name":"feeProtocol1Old","type":"uint8"},{"indexed":false,"internalType":"uint8","name":"feeProtocol0New","type":"uint8"},{"indexed":false,"internalType":"uint8","name":"feeProtocol1New","type":"uint8"}],"name":"SetFeeProtocol","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"sender","type":"address"},{"indexed":true,"internalType":"address","name":"recipient","type":"address"},{"indexed":false,"internalType":"int256","name":"amount0","type":"int256"},{"indexed":false,"internalType":"int256","name":"amount1","type":"int256"},{"indexed":false,"internalType":"uint160","name":"sqrtPriceX96","type":"uint160"},{"indexed":false,"internalType":"uint128","name":"liquidity","type":"uint128"},{"indexed":false,"internalType":"int24","name":"tick","type":"int24"}],"name":"Swap","type":"event"},{"inputs":[{"internalType":"int24","name":"tickLower","type":"int24"},{"internalType":"int24","name":"tickUpper","type":"int24"},{"internalType":"uint128","name":"amount","type":"uint128"}],"name":"burn","outputs":[{"internalType":"uint256","name":"amount0","type":"uint256"},{"internalType":"uint256","name":"amount1","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"int24","name":"tickLower","type":"int24"},{"internalType":"int24","name":"tickUpper","type":"int24"},{"internalType":"uint128","name":"amount0Requested","type":"uint128"},{"internalType":"uint128","name":"amount1Requested","type":"uint128"}],"name":"collect","outputs":[{"internalType":"uint128","name":"amount0","type":"uint128"},{"internalType":"uint128","name":"amount1","type":"uint128"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint128","name":"amount0Requested","type":"uint128"},{"internalType":"uint128","name":"amount1Requested","type":"uint128"}],"name":"collectProtocol","outputs":[{"internalType":"uint128","name":"amount0","type":"uint128"},{"internalType":"uint128","name":"amount1","type":"uint128"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"factory","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"fee","outputs":[{"internalType":"uint24","name":"","type":"uint24"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeGrowthGlobal0X128","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"feeGrowthGlobal1X128","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount0","type":"uint256"},{"internalType":"uint256","name":"amount1","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"flash","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint16","name":"observationCardinalityNext","type":"uint16"}],"name":"increaseObservationCardinalityNext","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint160","name":"sqrtPriceX96","type":"uint160"}],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"liquidity","outputs":[{"internalType":"uint128","name":"","type":"uint128"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxLiquidityPerTick","outputs":[{"internalType":"uint128","name":"","type":"uint128"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"int24","name":"tickLower","type":"int24"},{"internalType":"int24","name":"tickUpper","type":"int24"},{"internalType":"uint128","name":"amount","type":"uint128"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"mint","outputs":[{"internalType":"uint256","name":"amount0","type":"uint256"},{"internalType":"uint256","name":"amount1","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"observations","outputs":[{"internalType":"uint32","name":"blockTimestamp","type":"uint32"},{"internalType":"int56","name":"tickCumulative","type":"int56"},{"internalType":"uint160","name":"secondsPerLiquidityCumulativeX128","type":"uint160"},{"internalType":"bool","name":"initialized","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint32[]","name":"secondsAgos","type":"uint32[]"}],"name":"observe","outputs":[{"internalType":"int56[]","name":"tickCumulatives","type":"int56[]"},{"internalType":"uint160[]","name":"secondsPerLiquidityCumulativeX128s","type":"uint160[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"positions","outputs":[{"internalType":"uint128","name":"liquidity","type":"uint128"},{"internalType":"uint256","name":"feeGrowthInside0LastX128","type":"uint256"},{"internalType":"uint256","name":"feeGrowthInside1LastX128","type":"uint256"},{"internalType":"uint128","name":"tokensOwed0","type":"uint128"},{"internalType":"uint128","name":"tokensOwed1","type":"uint128"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"protocolFees","outputs":[{"internalType":"uint128","name":"token0","type":"uint128"},{"internalType":"uint128","name":"token1","type":"uint128"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint8","name":"feeProtocol0","type":"uint8"},{"internalType":"uint8","name":"feeProtocol1","type":"uint8"}],"name":"setFeeProtocol","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"slot0","outputs":[{"internalType":"uint160","name":"sqrtPriceX96","type":"uint160"},{"internalType":"int24","name":"tick","type":"int24"},{"internalType":"uint16","name":"observationIndex","type":"uint16"},{"internalType":"uint16","name":"observationCardinality","type":"uint16"},{"internalType":"uint16","name":"observationCardinalityNext","type":"uint16"},{"internalType":"uint8","name":"feeProtocol","type":"uint8"},{"internalType":"bool","name":"unlocked","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"int24","name":"tickLower","type":"int24"},{"internalType":"int24","name":"tickUpper","type":"int24"}],"name":"snapshotCumulativesInside","outputs":[{"internalType":"int56","name":"tickCumulativeInside","type":"int56"},{"internalType":"uint160","name":"secondsPerLiquidityInsideX128","type":"uint160"},{"internalType":"uint32","name":"secondsInside","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"bool","name":"zeroForOne","type":"bool"},{"internalType":"int256","name":"amountSpecified","type":"int256"},{"internalType":"uint160","name":"sqrtPriceLimitX96","type":"uint160"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"swap","outputs":[{"internalType":"int256","name":"amount0","type":"int256"},{"internalType":"int256","name":"amount1","type":"int256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"int16","name":"","type":"int16"}],"name":"tickBitmap","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"tickSpacing","outputs":[{"internalType":"int24","name":"","type":"int24"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"int24","name":"","type":"int24"}],"name":"ticks","outputs":[{"internalType":"uint128","name":"liquidityGross","type":"uint128"},{"internalType":"int128","name":"liquidityNet","type":"int128"},{"internalType":"uint256","name":"feeGrowthOutside0X128","type":"uint256"},{"internalType":"uint256","name":"feeGrowthOutside1X128","type":"uint256"},{"internalType":"int56","name":"tickCumulativeOutside","type":"int56"},{"internalType":"uint160","name":"secondsPerLiquidityOutsideX128","type":"uint160"},{"internalType":"uint32","name":"secondsOutside","type":"uint32"},{"internalType":"bool","name":"initialized","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"token0","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"token1","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"}]')
address = Web3.to_checksum_address(contract_address)
contract = web3.eth.contract(address = address, abi = abi )


address_token0 = contract.functions.token0().call()  # wstETH 0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0
address_token1 = contract.functions.token1().call()  # WETH 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2
decimals_0 = 18
decimals_1 = 18

#totalSupply = contract.functions.totalSupply().call()
tick = contract.functions.slot0().call()[1] 
rate_0_1 = 1.0001**tick* 10**(-decimals_1) / 10**(-decimals_0)

10**(-decimals_0) / 10**(-decimals_1)
print(f'the price is {rate_0_1}')  # 9 digits









